# DougHub Implementation Guide
## Adapted to Current Architecture (v15 Schema)

---

# ARCHITECTURE OVERVIEW

## The 3-Layer System

```
Layer 1: Knowledge Bank (source_items)
   Raw captured content - questions, articles, images
   Status: inbox → processed → curated

Layer 2: Notebook (notebook_topic_pages + notebook_blocks)
   What you learned from sources
   One page per topic, multiple blocks per page
   Each block = one source + your insight about it

Layer 3: Cards (cards)
   Flashcards generated from blocks
   FSRS-scheduled spaced repetition
```

## Key Architectural Decisions

1. **NotebookBlock = "Entry"** - What this guide calls an "entry" maps to a NotebookBlock
2. **One source → Multiple blocks** - Same source can create blocks in multiple topics
   - Example: "CKD causes CVD" → block in Nephrology AND block in Cardiology
   - Each block has its own insight tailored to that topic's perspective
3. **Block.content = user's insight** - The learning happens here
4. **Cards link to blocks** via `sourceBlockId`
5. **Links are block-to-block** - Cross-topic connections via notebook_links table

---

# FOUNDATION

## Database Schema (Current v15)

```sql
-- This reflects the ACTUAL schema in the codebase
-- See electron/database/schema.ts and migrations/

-- Canonical Topics (organization structure)
CREATE TABLE canonical_topics (
  id TEXT PRIMARY KEY,
  canonicalName TEXT NOT NULL,
  aliases TEXT NOT NULL DEFAULT '[]',    -- JSON array
  domain TEXT NOT NULL,                   -- e.g., "Nephrology", "Cardiology"
  parentTopicId TEXT REFERENCES canonical_topics(id),
  createdAt TEXT NOT NULL
);

-- Source Items (Knowledge Bank - Layer 1)
CREATE TABLE source_items (
  id TEXT PRIMARY KEY,
  sourceType TEXT NOT NULL,              -- qbank|article|pdf|image|audio|quickcapture|manual
  sourceName TEXT NOT NULL,
  sourceUrl TEXT,
  title TEXT NOT NULL,
  rawContent TEXT NOT NULL,
  mediaPath TEXT,                         -- For images/audio files
  tempImageData TEXT,                     -- Base64 for unsaved images
  transcription TEXT,                     -- For audio
  canonicalTopicIds TEXT NOT NULL DEFAULT '[]',  -- JSON array
  tags TEXT NOT NULL DEFAULT '[]',        -- JSON array
  questionId TEXT,                        -- For qbank tracking
  metadata TEXT,                          -- JSON: { summary, subject, questionType, extractedAt }
  status TEXT DEFAULT 'inbox',            -- inbox|processed|curated
  createdAt TEXT NOT NULL,
  processedAt TEXT,
  updatedAt TEXT
);

-- Notebook Topic Pages (Layer 2 - Container)
CREATE TABLE notebook_topic_pages (
  id TEXT PRIMARY KEY,
  canonicalTopicId TEXT NOT NULL REFERENCES canonical_topics(id),
  cardIds TEXT NOT NULL DEFAULT '[]',     -- JSON array (legacy, prefer block→card link)
  createdAt TEXT NOT NULL,
  updatedAt TEXT NOT NULL
);

-- Notebook Blocks (Layer 2 - Content Units)
-- Each block = one source item + user's insight about it
CREATE TABLE notebook_blocks (
  id TEXT PRIMARY KEY,
  notebookTopicPageId TEXT NOT NULL REFERENCES notebook_topic_pages(id),
  sourceItemId TEXT NOT NULL REFERENCES source_items(id),
  content TEXT NOT NULL,                  -- USER'S INSIGHT (what they learned)
  annotations TEXT,                       -- Optional notes/highlights
  mediaPath TEXT,                         -- Block-specific media
  position INTEGER NOT NULL,              -- Order within page
  cardCount INTEGER DEFAULT 0             -- Cards generated from this block
);

-- Notebook Links (Block-to-Block References) [TO BE CREATED - v16]
-- For AI-detected and manual backlinks
CREATE TABLE notebook_links (
  id TEXT PRIMARY KEY,
  sourceBlockId TEXT NOT NULL REFERENCES notebook_blocks(id),
  targetBlockId TEXT NOT NULL REFERENCES notebook_blocks(id),
  linkType TEXT NOT NULL,                 -- same_concept|related_topic|cross_specialty|comparison|builds_on
  reason TEXT,                            -- AI or user explanation
  anchorText TEXT,                        -- The phrase that triggered the link
  anchorStart INTEGER,                    -- Character position in source block
  anchorEnd INTEGER,
  createdAt TEXT NOT NULL,
  UNIQUE(sourceBlockId, targetBlockId)
);

-- Cards (Layer 3)
CREATE TABLE cards (
  id TEXT PRIMARY KEY,
  front TEXT NOT NULL,
  back TEXT NOT NULL,
  noteId TEXT NOT NULL,                   -- Legacy link to notes table
  tags TEXT NOT NULL DEFAULT '[]',        -- JSON array
  dueDate TEXT NOT NULL,
  createdAt TEXT NOT NULL,
  -- FSRS fields
  stability REAL DEFAULT 0,
  difficulty REAL DEFAULT 0,
  elapsedDays REAL DEFAULT 0,
  scheduledDays REAL DEFAULT 0,
  reps INTEGER DEFAULT 0,
  lapses INTEGER DEFAULT 0,
  state INTEGER DEFAULT 0,                -- 0=New, 1=Learning, 2=Review, 3=Relearning
  lastReview TEXT,
  -- v2 linking fields
  cardType TEXT DEFAULT 'standard',       -- standard|qa|cloze|vignette|list-cloze
  parentListId TEXT,                      -- For grouping medical list cards
  listPosition INTEGER,
  notebookTopicPageId TEXT REFERENCES notebook_topic_pages(id),
  sourceBlockId TEXT REFERENCES notebook_blocks(id),
  aiTitle TEXT                            -- AI-generated summary for Card Browser
);

-- Review History
CREATE TABLE review_logs (
  id TEXT PRIMARY KEY,
  cardId TEXT NOT NULL REFERENCES cards(id),
  rating INTEGER NOT NULL,                -- 1=Again, 2=Hard, 3=Good, 4=Easy
  state INTEGER NOT NULL,
  scheduledDays REAL NOT NULL,
  elapsedDays REAL NOT NULL,
  review TEXT NOT NULL,
  createdAt TEXT NOT NULL,
  responseTimeMs INTEGER,                 -- For auto-grading
  partialCreditScore REAL,                -- 0.0-1.0 for list partial recall
  responseTimeModifier REAL,              -- Interval adjustment factor
  userAnswer TEXT,                        -- Future: typed answer mode
  userExplanation TEXT                    -- Future: exam trap detection
);

-- Indexes (already exist)
CREATE INDEX idx_source_items_status ON source_items(status);
CREATE INDEX idx_notebook_blocks_page ON notebook_blocks(notebookTopicPageId);
CREATE INDEX idx_cards_dueDate ON cards(dueDate);
CREATE INDEX idx_cards_state ON cards(state);
CREATE INDEX idx_cards_sourceBlockId ON cards(sourceBlockId);
```

## TypeScript Interfaces (from electron/database/types.ts)

```typescript
// Enums
type CardType = "standard" | "qa" | "cloze" | "vignette" | "list-cloze";
type SourceType = "qbank" | "article" | "pdf" | "image" | "audio" | "quickcapture" | "manual";
type SourceItemStatus = "inbox" | "processed" | "curated";

// Layer 1: Knowledge Bank
interface DbSourceItem {
  id: string;
  sourceType: SourceType;
  sourceName: string;
  sourceUrl?: string;
  title: string;
  rawContent: string;
  mediaPath?: string;
  tempImageData?: string;
  transcription?: string;
  canonicalTopicIds: string[];
  tags: string[];
  questionId?: string;
  metadata?: {
    summary?: string;
    subject?: string;
    questionType?: string;
    extractedAt?: string;
  };
  status: SourceItemStatus;
  createdAt: string;
  processedAt?: string;
  updatedAt?: string;
}

// Layer 2: Notebook
interface DbCanonicalTopic {
  id: string;
  canonicalName: string;
  aliases: string[];
  domain: string;
  parentTopicId?: string;
  createdAt: string;
}

interface DbNotebookTopicPage {
  id: string;
  canonicalTopicId: string;
  cardIds: string[];
  createdAt: string;
  updatedAt: string;
}

interface DbNotebookBlock {
  id: string;
  notebookTopicPageId: string;
  sourceItemId: string;
  content: string;           // USER'S INSIGHT - the learning
  annotations?: string;
  mediaPath?: string;
  position: number;
  cardCount: number;
}

// Future: notebook_links table
interface DbNotebookLink {
  id: string;
  sourceBlockId: string;
  targetBlockId: string;
  linkType: 'same_concept' | 'related_topic' | 'cross_specialty' | 'comparison' | 'builds_on';
  reason?: string;
  anchorText?: string;
  anchorStart?: number;
  anchorEnd?: number;
  createdAt: string;
}

// Layer 3: Cards
interface DbCard {
  id: string;
  front: string;
  back: string;
  noteId: string;
  tags: string[];
  dueDate: string;
  createdAt: string;
  // FSRS
  stability: number;
  difficulty: number;
  elapsedDays: number;
  scheduledDays: number;
  reps: number;
  lapses: number;
  state: number;
  lastReview: string | null;
  // v2 fields
  cardType: CardType;
  parentListId: string | null;
  listPosition: number | null;
  notebookTopicPageId: string | null;
  sourceBlockId: string | null;
  aiTitle: string | null;
}

interface DbReviewLog {
  id: string;
  cardId: string;
  rating: number;
  state: number;
  scheduledDays: number;
  elapsedDays: number;
  review: string;
  createdAt: string;
  responseTimeMs: number | null;
  partialCreditScore: number | null;
  responseTimeModifier: number | null;
  userAnswer: string | null;
  userExplanation: string | null;
}
```

## IPC Pattern

All database operations follow this flow:
```
React Component
  → window.api.methodName(args)
    → IPC invoke (preload.ts)
      → Handler (ipc-handlers.ts)
        → Query function (database/*.ts)
          → SQLite
        ← IpcResult<T>
      ← { data, error }
    ← Promise<T>
  ← Update Zustand store
```

---

# WORKFLOW 1: Quick Capture

## Screen

```
+-----------------------------------------------------------------------------+
|  CAPTURE                                                            [X]     |
|                                                                             |
|  +---------------------------------------------------------------------+   |
|  | [Paste or type content here...]                                     |   |
|  |                                                                     |   |
|  |                                                                     |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  Title: [CKD G3 - Leading Cause of Death              ] [pencil]           |
|                                                                             |
|  Type:  [QBank v]     Result: (*) Correct  ( ) Incorrect                   |
|                                                                             |
|  Domain: [Nephrology v]                                                    |
|                                                                             |
|  Tags: [Cardiology] [Management] [Cross-Topic]  [+ Add]                    |
|                                                                             |
|  ! Similar item exists: "CKD G3 - CV Risk" [View]                          |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|           [ Save to Inbox ]              [ Add to Notebook Now -> ]        |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User opens capture (Ctrl+Shift+C or FAB button)
2. User pastes content
3. AI analyzes content (see AI Prompt below)
4. Form auto-fills with AI suggestions
5. Check for duplicates (search source_items by title similarity)
6. User confirms/edits fields
7. User clicks:
   - [Save to Inbox] -> INSERT source_items, status='inbox', done
   - [Add to Notebook Now ->] -> Go to Workflow 2 with this source
```

## AI Prompt: Capture Analysis

```
SYSTEM: Analyze medical content for tagging and organization.

INPUT:
{raw_content}

OUTPUT JSON:
{
  "title": "Short title (<10 words)",
  "sourceType": "qbank|article|pdf|image|quickcapture|manual",
  "domain": "Nephrology",
  "secondaryDomains": ["Cardiology"],
  "tags": ["Management", "Boards-HY"],
  "extractedFacts": ["CKD 4-5x more likely CVD death than ESKD", "..."],
  "suggestedTopic": "Chronic Kidney Disease"
}

DETECTION RULES:
- Contains "A) B) C) D)" AND "Explanation" -> sourceType = "qbank"
- URL from UpToDate, PubMed -> sourceType = "article"
- User-written, no citations -> sourceType = "manual"
- Otherwise -> sourceType = "quickcapture"
```

## Database Operations

```typescript
// On [Save to Inbox] - uses sourceItemQueries.create()
await window.api.createSourceItem({
  id: crypto.randomUUID(),
  sourceType: aiResult.sourceType,
  sourceName: 'Quick Capture',
  title: aiResult.title,
  rawContent: content,
  canonicalTopicIds: [],
  tags: [...aiResult.secondaryDomains, ...aiResult.tags],
  metadata: {
    summary: aiResult.extractedFacts?.join('; '),
    subject: aiResult.domain
  },
  status: 'inbox',
  createdAt: new Date().toISOString(),
});
```

## Edge Cases

**AI fails or times out:**
- Show form with defaults: sourceType='quickcapture', title=first 50 chars, domain='General', tags=[]
- Never block capture. User can fill manually.

**Duplicate detected:**
- Search: sourceItemQueries.search(keywords)
- If found, show warning with [View Existing] option
- User can still save (might be different angle on same topic)

**Image/PDF pasted:**
- Store base64 in tempImageData, sourceType='image' or 'pdf'
- AI cannot analyze -> manual tagging required
- Show: "Image captured. Please add title and tags."

---

# WORKFLOW 2: Add to Notebook

**THIS IS WHERE LEARNING HAPPENS.** The insight field is not optional metadata - it's
the entire point. Users must articulate what they learned in their own words.
Without this step, DougHub is just a content collector, not a learning tool.

## Screen

```
+-----------------------------------------------------------------------------+
|  ADD TO NOTEBOOK                                                    [X]     |
|                                                                             |
|  +-----------------------------------------------------------------------+  |
|  | SOURCE PREVIEW (collapsed by default, expandable)                     |  |
|  | "CKD G3 - Leading Cause of Death" (QBank - Correct)          [Expand] |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
|  Topic: [Chronic Kidney Disease v]     [+ Create New Topic]                |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|   WHAT DID YOU LEARN?                                                      |
|   Write it in your own words. This becomes your notebook entry.            |
|                                                                             |
|  +---------------------------------------------------------------------+   |
|  |                                                                     |   |
|  | CKD patients are 4-5x more likely to die of CVD than progress to   |   |
|  | ESKD. Both CKD and albuminuria are independent CV risk factors.    |   |
|  |                                                                     |   |
|  | Key takeaway: Manage CV risk aggressively in CKD - statins, BP     |   |
|  | control, smoking cessation. Don't just focus on slowing GFR        |   |
|  | decline.                                                            |   |
|  |                                                                     |   |
|  +---------------------------------------------------------------------+   |
|   Min 20 characters                                          [142 chars]   |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|  Already in this topic:                                                    |
|  - CKD Staging and GFR (your insight: "G3a vs G3b distinction...")        |
|  - ACEi in CKD (your insight: "Renoprotective independent of BP...")      |
|                                                                             |
|  Tags: [Cardiology] [Management] [Cross-Topic]  [+ Add]                    |
|                                                                             |
|                    [ Save Draft ]              [ Save to Notebook ]        |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Why This Design

1. **Insight field is PROMINENT** - largest element, visually emphasized
2. **Source is collapsed** - reference material, not the focus
3. **Minimum character count** - prevents empty/lazy entries
4. **"In your own words"** - explicit instruction to process, not copy
5. **Existing blocks show YOUR insights** - reinforces that this is about learning
6. **Save Draft option** - for partial work, but encourages completion

## Flow

```
1. User arrives from:
   - Workflow 1 ([Add to Notebook Now])
   - Inbox item -> [Add to Notebook]

2. Source preview collapsed (click to expand and review)

3. AI suggests topic based on source tags/domain

4. User selects topic OR creates new topic

5. ** THE KEY STEP **
   User writes their insight - what they learned, in their own words
   - Minimum 20 characters enforced
   - Character count shown
   - Cannot save with empty insight

6. Tags inherited from source, user can modify

7. User clicks [Save to Notebook]

8. System creates:
   - NotebookTopicPage (if not exists for topic)
   - NotebookBlock (links source + user insight)
   - Updates source status to 'processed'

9. Trigger backlinks detection (async)
```

## Database Operations

```typescript
// On [Save to Notebook] - transaction
async function addToNotebook(sourceItem: DbSourceItem, topicId: string, userInsight: string) {
  // 1. Get or create topic page
  let page = await window.api.getNotebookTopicPageByTopic(topicId);
  if (!page) {
    page = await window.api.createNotebookTopicPage({
      id: crypto.randomUUID(),
      canonicalTopicId: topicId,
      cardIds: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    });
  }

  // 2. Get next position
  const blocks = await window.api.getNotebookBlocksByPage(page.id);
  const nextPosition = blocks.length;

  // 3. Create block
  await window.api.createNotebookBlock({
    id: crypto.randomUUID(),
    notebookTopicPageId: page.id,
    sourceItemId: sourceItem.id,
    content: userInsight,  // User's learning - the KEY field
    position: nextPosition,
    cardCount: 0,
  });

  // 4. Update source status
  await window.api.updateSourceItemStatus(sourceItem.id, 'processed');

  // 5. Future: Queue backlink detection
  // queueBacklinkDetection(blockId);
}
```

## Creating New Topic (Inline)

```typescript
await window.api.createCanonicalTopic({
  id: crypto.randomUUID(),
  canonicalName: 'Cardiorenal Syndrome',
  aliases: [],
  domain: 'Nephrology',
  createdAt: new Date().toISOString(),
});
```

## Edge Cases

**Topic doesn't exist:**
- Show [+ Create New Topic] inline form
- Minimal fields: name, domain
- Create immediately, continue with block

**Block already exists for this source in this topic:**
- Check: notebookBlockQueries.getBySourceAndPage(sourceId, pageId)
- If found: "You already have a block from this source in [Topic]"
- Options: [View Existing] | [Add Anyway] | [Choose Different Topic]

**No source (direct entry creation):**
- Valid for clinical pearls entered directly
- Create source_item with sourceType='manual' first, then link

---

# WORKFLOW 3: AI Backlink Detection (Async) [FUTURE]

**Status: NOT YET IMPLEMENTED - Requires notebook_links table (v16)**

## When It Runs

```
Triggers:
- After notebook block created (Workflow 2)
- After notebook block edited with significant content change

Runs asynchronously - never blocks the save operation.
```

## AI Prompt: Backlink Detection

```
SYSTEM: Find related notebook blocks and identify anchor phrases.

NEW BLOCK:
Content: {content}
Topic: {topicName}
Tags: {tags}

EXISTING BLOCKS (candidates):
[
  { "id": "abc123", "topicName": "CKD Staging", "excerpt": "GFR cutoffs..." },
  { "id": "def456", "topicName": "Statin Therapy", "excerpt": "When to start..." },
  ...
]

OUTPUT JSON:
{
  "relatedBlocks": [
    {
      "blockId": "abc123",
      "reason": "Same disease context",
      "linkType": "same_concept",
      "anchorText": "CKD patients",
      "anchorStart": 0,
      "anchorEnd": 12
    }
  ]
}

RULES:
- Max 5 related blocks
- Only genuinely related content
- anchorText must be exact substring of content
```

## Database Operations (Future)

```typescript
// For each related block from AI
for (const rel of aiResult.relatedBlocks) {
  await db.run(`
    INSERT INTO notebook_links (
      id, sourceBlockId, targetBlockId, linkType, reason,
      anchorText, anchorStart, anchorEnd, createdAt
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ON CONFLICT(sourceBlockId, targetBlockId) DO UPDATE SET
      reason = excluded.reason,
      anchorText = excluded.anchorText
  `, [uuid(), blockId, rel.blockId, rel.linkType, rel.reason,
      rel.anchorText, rel.anchorStart, rel.anchorEnd, new Date().toISOString()]);
}
```

---

# WORKFLOW 4: Browse Inbox

## Screen

```
+-----------------------------------------------------------------------------+
|  INBOX (23 items)                                                          |
|                                                                             |
|  [Search...]                    [Sort: Newest v]  [Filter: All Types v]    |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  [ ] CKD G3 - CV Mortality                [Nephro] QBank check   2 hrs ago |
|  [ ] Afib Rate Control vs Rhythm          [Cardio] QBank x       3 hrs ago |
|  [ ] COPD Exacerbation Management         [Pulm]   QBank check   Yesterday |
|  [ ] Diabetic Ketoacidosis Workup         [Endo]   QBank x       Yesterday |
|  [ ] UpToDate: Heart Failure Guidelines   [Cardio] Article       2 days    |
|  ...                                                                        |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  With selected: [Add to Notebook] [Archive] [Delete]                       |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User opens Inbox from sidebar
2. Load items: sourceItemQueries.getByStatus('inbox')
3. User can:
   - Click item -> View source detail modal
   - Select + [Add to Notebook] -> Workflow 2
   - Select + [Archive] -> status = 'curated'
   - Select + [Delete] -> DELETE with confirmation
4. Filters: by sourceType, domain (from metadata.subject)
5. Sort: by createdAt (newest/oldest)
```

## Database Operations

```typescript
// List inbox
const items = await window.api.getSourceItemsByStatus('inbox');

// Archive (mark as curated)
await window.api.updateSourceItemStatus(id, 'curated');

// Delete
await window.api.deleteSourceItem(id);
```

## Edge Cases

**Empty inbox:**
- Show: "Inbox empty! Capture some content to get started." [Capture]

**Batch actions on many items:**
- Archive: Update all, no confirmation needed
- Delete: Confirm "Delete X items? This cannot be undone."

---

# WORKFLOW 5: Browse Notebook

## Screen

```
+-----------------------------------------------------------------------------+
|  NOTEBOOK                                                [Search...]       |
|                                                                             |
|  +--------------+ +----------------------------------------------------+   |
|  | DOMAINS      | |  Chronic Kidney Disease                   12 blocks|   |
|  |              | |                                                    |   |
|  | v Nephrology | |  +----------------------------------------------+ |   |
|  |   - CKD (12) | |  | CKD - CV Mortality Risk            2hrs ago  | |   |
|  |   - AKI (5)  | |  | [Cardio] [Mgmt] [Cross-Topic]                | |   |
|  |   - GN (3)   | |  | "CKD patients 4-5x more likely to die..."    | |   |
|  |              | |  | Links: 3  Source: 1  Cards: 0                | |   |
|  | > Cardiology | |  +----------------------------------------------+ |   |
|  | > Pulmonology| |                                                    |   |
|  | > GI         | |  +----------------------------------------------+ |   |
|  | > Endocrine  | |  | CKD Staging and GFR                2 days ago| |   |
|  | ...          | |  | [Dx] [Boards-HY]                             | |   |
|  |              | |  | "Stage G3a: 45-59, G3b: 30-44..."            | |   |
|  | ------------ | |  | Links: 2  Source: 2  Cards: 1                | |   |
|  | FILTERS:     | |  +----------------------------------------------+ |   |
|  | [ ] Cross-Top| |                                                    |   |
|  | [ ] Boards-HY| |  [+ Add Block]                                    |   |
|  | [ ] No Cards | |                                                    |   |
|  +--------------+ +----------------------------------------------------+   |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User opens Notebook from sidebar
2. Left sidebar: domains with nested topics
   - Expand domain -> show topics with block counts
3. Click topic -> load blocks for that topic's page
4. Click block card -> Workflow 6 (Block Detail)
5. Filters affect block list
6. Search searches across all blocks (content field)
```

## Database Queries

```typescript
// Get domain tree with counts
const topics = await window.api.getAllCanonicalTopics();
// Group by domain, count blocks per topic

// Get blocks for topic
const page = await window.api.getNotebookTopicPageByTopic(topicId);
const blocks = await window.api.getNotebookBlocksByPage(page.id);

// For each block, fetch source info
for (const block of blocks) {
  block.source = await window.api.getSourceItem(block.sourceItemId);
}
```

---

# WORKFLOW 6: Block Detail View

## Screen (Default)

```
+-----------------------------------------------------------------------------+
|  <- Back to CKD                                         [Edit] [...]       |
|                                                                             |
|  CKD - CV Mortality Risk                                                   |
|  [Nephrology] [Cardiology] [Management] [Cross-Topic]                      |
|                                                                     +-----+|
|  ===================================================================|Lnk 3||
|                                                                     |  >  ||
|  CKD patients are 4-5x more likely to die of CVD than progress     |     ||
|  to ESKD. Both CKD and albuminuria are independent CV risk         |     ||
|  factors. Key management: treat CV risk factors (statins, BP       |     ||
|  control).                                                          |     ||
|                                                                     |     ||
|  ===================================================================|     ||
|                                                                     +-----+|
|  SOURCE                                                     [View Full]   |
|  QBank: CKD G3 - Leading Cause of Death  (check) Correct                   |
|                                                                             |
|  CARDS: None                                          [Generate Card]     |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Screen (Links Sidebar Expanded) [FUTURE]

```
+-----------------------------------------------------------------------------+
|  <- Back to CKD                                               [Edit] [...]  |
|                                                                             |
|  +---------------------------------------------+-------------------------+  |
|  |                                             | REFERENCES              |  |
|  |  CKD - CV Mortality Risk                    |                         |  |
|  |  [Nephro] [Cardio] [Mgmt] [Cross]          | -> CKD Staging          |  |
|  |                                             |    "CKD patients"       |  |
|  |  =========================================  |                         |  |
|  |                                             | -> Statin Therapy       |  |
|  |  CKD patients are 4-5x more likely to die  |    "statins"            |  |
|  |  of CVD than progress to ESKD. Both CKD    |                         |  |
|  |  and albuminuria are independent CV risk   | -> HTN in CKD           |  |
|  |  factors. Key management: treat CV risk    |    "BP control"         |  |
|  |  factors (statins, BP control).            |                         |  |
|  |                                             | --------------------    |  |
|  |  =========================================  |                         |  |
|  |                                             | LINKED FROM             |  |
|  |  SOURCE                          [View]    | <- Diabetic Nephro      |  |
|  |  QBank: CKD G3...  (check)                 |                         |  |
|  |                                             | [+ Add Link]            |  |
|  |  CARDS: None          [Generate Card]      |                         |  |
|  |                                             |                         |  |
|  +---------------------------------------------+-------------------------+  |
|                                                                             |
+-----------------------------------------------------------------------------+

INTERACTIONS:
- Hover "-> CKD Staging" -> "CKD patients" highlights in content
- Click "-> CKD Staging" -> Navigate to that block
- Sidebar collapsed by default, click link count to expand
```

## Database Queries

```typescript
// Get block with source
const block = await window.api.getNotebookBlock(blockId);
const source = await window.api.getSourceItem(block.sourceItemId);
const topic = await window.api.getCanonicalTopic(page.canonicalTopicId);

// Get cards for this block
const cards = await window.api.getCardsBySourceBlock(blockId);

// Future: Get links
// const linksTo = await window.api.getLinksFromBlock(blockId);
// const linkedFrom = await window.api.getLinksToBlock(blockId);
```

---

# WORKFLOW 7: Edit Block [FUTURE ENHANCEMENT]

## Screen

```
+-----------------------------------------------------------------------------+
|  <- Back                                              [Cancel] [Save]       |
|                                                                             |
|  EDITING: CKD - CV Mortality Risk                                          |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  Content (your insight):                                                   |
|  +---------------------------------------------------------------------+   |
|  | CKD patients are 4-5x more likely to die of CVD than progress to   |   |
|  | ESKD. Both CKD and albuminuria are independent CV risk factors.    |   |
|  | Key management: treat CV risk factors (statins, BP control).       |   |
|  |                                                                     |   |
|  | UPDATE: Also important to control phosphorus in later stages.      |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  ! This block has 2 cards. Editing may make them stale.                    |
|     [View Cards]                                                           |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User clicks [Edit] on block detail
2. Content field becomes editable
3. User modifies content
4. User clicks [Save]
5. If block has cards, warn about staleness
6. Future: If content changed significantly, re-run backlink detection
```

## Database Operations

```typescript
// Update block content
await window.api.updateNotebookBlock(blockId, {
  content: newContent,
});

// Future: Re-detect backlinks if significant change
// if (levenshteinRatio(oldContent, newContent) > 0.3) {
//   queueBacklinkDetection(blockId);
// }
```

---

# WORKFLOW 8: Add Source to Another Topic

This is the KEY workflow for cross-topic knowledge. When a source touches multiple domains
(e.g., "CKD causes CVD"), the user should add it to both Nephrology AND Cardiology.

## Screen

```
+-----------------------------------------------------------------------------+
|  ADD TO ANOTHER TOPIC                                               [X]     |
|                                                                             |
|  Source: "CKD G3 - Leading Cause of Death" (QBank)                         |
|                                                                             |
|  Already in:                                                                |
|  - Chronic Kidney Disease (Nephrology) - "CKD patients are 4-5x..."        |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  Add to: [Cardiovascular Disease v]     [+ Create New Topic]               |
|                                                                             |
|  What's the Cardiology angle? (write a different insight)                  |
|  +---------------------------------------------------------------------+   |
|  | CV disease is the leading cause of death in CKD patients, NOT       |   |
|  | progression to dialysis. Statins and BP control are essential.      |   |
|  | Consider CKD as a coronary risk equivalent.                         |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  [ ] Link these blocks (show connection in both topics)                    |
|                                                                             |
|                                              [ Add to Topic ]              |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User clicks [+ Add to Another Topic] on:
   - Source item in Knowledge Bank
   - Existing block in Notebook (shows "Already in: X")

2. Show source info and existing blocks from this source

3. User selects different topic

4. User writes NEW insight for this topic's perspective
   - Nephrology angle: "CKD patients die of CVD, manage CV risk"
   - Cardiology angle: "CKD is a coronary risk equivalent, screen for it"

5. Optional: Check "Link these blocks" to create notebook_link

6. Creates new block in new topic, same sourceItemId
```

## Database Operations

```typescript
async function addSourceToAnotherTopic(
  sourceItem: DbSourceItem,
  newTopicId: string,
  newInsight: string,
  linkToExisting: boolean,
  existingBlockId?: string
) {
  // 1. Get or create topic page
  let page = await window.api.getNotebookTopicPageByTopic(newTopicId);
  if (!page) {
    page = await window.api.createNotebookTopicPage({
      id: crypto.randomUUID(),
      canonicalTopicId: newTopicId,
      cardIds: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    });
  }

  // 2. Get next position
  const blocks = await window.api.getNotebookBlocksByPage(page.id);
  const nextPosition = blocks.length;

  // 3. Create new block (same source, different topic, different insight)
  const newBlockId = crypto.randomUUID();
  await window.api.createNotebookBlock({
    id: newBlockId,
    notebookTopicPageId: page.id,
    sourceItemId: sourceItem.id,  // SAME source
    content: newInsight,           // DIFFERENT insight
    position: nextPosition,
    cardCount: 0,
  });

  // 4. Optionally create link between blocks
  if (linkToExisting && existingBlockId) {
    await window.api.createNotebookLink({
      id: crypto.randomUUID(),
      sourceBlockId: existingBlockId,
      targetBlockId: newBlockId,
      linkType: 'cross_specialty',
      reason: 'Same source, different topic perspective',
      createdAt: new Date().toISOString(),
    });
  }

  // 5. Update source status if still inbox
  if (sourceItem.status === 'inbox') {
    await window.api.updateSourceItemStatus(sourceItem.id, 'processed');
  }
}
```

## Edge Cases

**Block already exists in target topic:**
- Check: notebookBlockQueries.getBySourceAndPage(sourceId, pageId)
- If found: "You already have this source in [Topic]. View it?"

**User wants to copy insight instead of writing new:**
- Offer [Copy from existing] button
- Pre-fill textarea, user can modify

---

# WORKFLOW 9: Add Manual Link

Create explicit connections between blocks across topics.

## Screen

```
+-----------------------------------------------------------------------------+
|  + ADD LINK                                                         [X]     |
|                                                                             |
|  Linking from: "CKD - CV Mortality Risk" (Nephrology)                      |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  Search blocks: [statin                    ]                               |
|                                                                             |
|  +------------------------------------------------------------------------+ |
|  | (*) Statin Therapy - When to Start                        [Cardio]    | |
|  |     "High-intensity statins for all diabetics..."                     | |
|  |                                                                        | |
|  | ( ) Statin Side Effects                                   [Pharm]     | |
|  |     "Myopathy risk factors include..."                                | |
|  |                                                                        | |
|  | ( ) CKD and Dyslipidemia                                  [Nephro]    | |
|  |     "LDL targets in CKD differ from general population..."            | |
|  +------------------------------------------------------------------------+ |
|                                                                             |
|  Link type: [Related Topic v]                                              |
|                                                                             |
|  Optional anchor text (highlight in your block):                           |
|  Selected: "statins"                                                       |
|                                                                             |
|                                                        [Create Link]       |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User clicks [+ Add Link] in block detail sidebar
2. Search modal opens
3. User searches by keyword, filters by topic/domain
4. User selects target block
5. User selects link type:
   - same_concept: Same idea, different words
   - related_topic: Connected but distinct
   - cross_specialty: Same content, different specialty
   - comparison: Compare/contrast
   - builds_on: This block extends that one
6. Optional: User highlights text in current block for anchor
7. Creates notebook_link record
```

## Database Operations

```typescript
// Search for blocks
const results = await window.api.searchNotebookBlocks(searchTerm);
// Returns blocks with topic name, excerpt

// Create link
await window.api.createNotebookLink({
  id: crypto.randomUUID(),
  sourceBlockId: currentBlockId,
  targetBlockId: selectedBlockId,
  linkType: selectedLinkType,
  reason: 'Manual link',
  anchorText: selectedText || null,
  anchorStart: selectionStart || null,
  anchorEnd: selectionEnd || null,
  createdAt: new Date().toISOString(),
});
```

## Edge Cases

**Link already exists:**
- Check before creating
- If exists: "Already linked. Update anchor text?"

**Self-link:**
- Filter current block from search results

**Circular links:**
- A→B and B→A are both valid (bidirectional relationship)
- Show both in respective sidebars

---

# WORKFLOW 10: Remove Link

## Screen

```
In block detail sidebar, each link shows [x] button:

+-------------------------+
| REFERENCES              |
|                         |
| -> CKD Staging     [x]  |
|    "CKD patients"       |
|                         |
| -> Statin Therapy  [x]  |
|    "statins"            |
+-------------------------+
```

## Flow

```
1. User clicks [x] on link in sidebar
2. Confirm: "Remove link to [Statin Therapy]?" [Remove] [Cancel]
3. DELETE FROM notebook_links WHERE id = ?
4. Sidebar refreshes
```

## Database Operations

```typescript
// On confirm
await window.api.deleteNotebookLink(linkId);
```

## Edge Cases

**Bidirectional links:**
- Removing A→B does NOT remove B→A
- Each direction is independent

---

# WORKFLOW 11: Generate Card

## Screen

```
+-----------------------------------------------------------------------------+
|  GENERATE CARD                                                      [X]     |
|                                                                             |
|  From block: "CKD - CV Mortality Risk"                                     |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  FRONT:                                                                    |
|  +---------------------------------------------------------------------+   |
|  | A patient with CKD stage G3 is more likely to _____ than progress  |   |
|  | to ESKD requiring dialysis.                                         |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  BACK:                                                                     |
|  +---------------------------------------------------------------------+   |
|  | Die of cardiovascular disease (4-5x more likely)                    |   |
|  |                                                                     |   |
|  | -> Manage CV risk factors: statins, BP control                     |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  Type: [Cloze v]                                                           |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|       [Regenerate]          [Edit]          [Create Card]                  |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## AI Prompt: Card Generation

```
SYSTEM: Generate a flashcard from this notebook block.

BLOCK CONTENT (user's insight):
{block.content}

SOURCE INFO:
Type: {source.sourceType}
Title: {source.title}
Was correct: {source.metadata?.wasCorrect}

OUTPUT JSON:
{
  "front": "Question or cloze prompt",
  "back": "Answer with key fact",
  "cardType": "cloze|qa|vignette|standard",
  "aiTitle": "Short summary for card browser"
}

RULES:
- Clinical vignette style for QBank-derived content
- Cloze for specific facts/numbers
- Back should be concise (<50 words)
- If wasCorrect=false, focus on the misconception
```

## Database Operations

```typescript
// On [Create Card]
const cardId = crypto.randomUUID();

await window.api.createCard({
  id: cardId,
  front: front,
  back: back,
  noteId: '',  // Legacy field
  tags: block.tags || [],
  dueDate: new Date().toISOString(),
  createdAt: new Date().toISOString(),
  // FSRS initial values
  stability: 0,
  difficulty: 0,
  elapsedDays: 0,
  scheduledDays: 0,
  reps: 0,
  lapses: 0,
  state: 0,  // New
  lastReview: null,
  // v2 linking
  cardType: cardType,
  notebookTopicPageId: block.notebookTopicPageId,
  sourceBlockId: block.id,
  aiTitle: aiResult.aiTitle,
});

// Update block card count
await window.api.incrementBlockCardCount(block.id);
```

---

# WORKFLOW 12: Daily Review

## Screen (Question)

```
+-----------------------------------------------------------------------------+
|  REVIEW                                              12 cards remaining    |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|                                                                             |
|     A patient with CKD stage G3 is more likely to _____ than progress      |
|     to ESKD requiring dialysis.                                            |
|                                                                             |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|                                                                             |
|                           [Show Answer] (Space)                            |
|                                                                             |
|                                                                             |
|  -------------------------------------------------------------------------  |
|  [View Block]                                                  [Skip Card] |
+-----------------------------------------------------------------------------+
```

## Screen (Answer Revealed)

```
+-----------------------------------------------------------------------------+
|  REVIEW                                              12 cards remaining    |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|     A patient with CKD stage G3 is more likely to _____ than progress      |
|     to ESKD requiring dialysis.                                            |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|     Die of cardiovascular disease (4-5x more likely)                       |
|                                                                             |
|     -> Manage CV risk factors: statins, BP control                        |
|                                                                             |
|  =========================================================================  |
|                                                                             |
|                                                                             |
|              [I Forgot] (F)                    [Continue] (Enter)          |
|                                                                             |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Flow

```
1. User opens Review from sidebar
2. Get due cards: cardQueries.getDue()
3. If no cards due: "All caught up! Next: X cards due tomorrow"
4. Show card front, start timer
5. User presses Space -> reveal back
6. User presses:
   - Enter = "I knew it"
   - F = "I forgot"
7. Auto-grade based on response time:
   - <3 sec + Enter = Rating.Good (3)
   - 3-8 sec + Enter = Rating.Hard (2)
   - >8 sec + Enter = Rating.Hard (2)
   - F = Rating.Again (1)
8. ts-fsrs calculates new schedule
9. Update card, log to review_logs
10. Next card or "Done!"
```

## FSRS Integration

```typescript
import { FSRS, Rating, Card as FSRSCard } from 'ts-fsrs';

const fsrs = new FSRS();

function gradeCard(card: DbCard, responseTimeMs: number, forgot: boolean) {
  // Determine rating
  let rating: Rating;
  if (forgot) {
    rating = Rating.Again;
  } else if (responseTimeMs < 3000) {
    rating = Rating.Good;
  } else {
    rating = Rating.Hard;
  }

  // Convert to FSRS card format
  const fsrsCard: FSRSCard = {
    difficulty: card.difficulty,
    stability: card.stability,
    due: new Date(card.dueDate),
    state: card.state,
    reps: card.reps,
    lapses: card.lapses,
    elapsed_days: card.elapsedDays,
    scheduled_days: card.scheduledDays,
    last_review: card.lastReview ? new Date(card.lastReview) : undefined,
  };

  // Schedule next review
  const result = fsrs.repeat(fsrsCard, new Date())[rating];

  // Update card via IPC
  await window.api.updateCard(card.id, {
    difficulty: result.card.difficulty,
    stability: result.card.stability,
    dueDate: result.card.due.toISOString(),
    state: result.card.state,
    reps: result.card.reps,
    lapses: result.card.lapses,
    elapsedDays: result.card.elapsed_days,
    scheduledDays: result.card.scheduled_days,
    lastReview: new Date().toISOString(),
  });

  // Log review
  await window.api.createReviewLog({
    id: crypto.randomUUID(),
    cardId: card.id,
    rating: rating,
    state: card.state,
    scheduledDays: result.card.scheduled_days,
    elapsedDays: result.card.elapsed_days,
    review: new Date().toISOString(),
    createdAt: new Date().toISOString(),
    responseTimeMs: responseTimeMs,
  });
}
```

---

# WORKFLOW 13: Edit Card

## Screen

```
+-----------------------------------------------------------------------------+
|  EDIT CARD                                                          [X]     |
|                                                                             |
|  From block: "CKD - CV Mortality Risk"                                     |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|  FRONT:                                                                    |
|  +---------------------------------------------------------------------+   |
|  | A patient with CKD stage G3 is more likely to _____ than progress  |   |
|  | to ESKD requiring dialysis.                                         |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  BACK:                                                                     |
|  +---------------------------------------------------------------------+   |
|  | Die of cardiovascular disease (4-5x more likely)                    |   |
|  |                                                                     |   |
|  | -> Manage CV risk factors: statins, BP control                     |   |
|  +---------------------------------------------------------------------+   |
|                                                                             |
|  Type: [Cloze v]        Status: [Active v]                                |
|                                                                             |
|  -------------------------------------------------------------------------  |
|                                                                             |
|       [Reset Progress]                              [Cancel] [Save]        |
|                                                                             |
+-----------------------------------------------------------------------------+
```

## Database Operations

```typescript
// Normal save (keep FSRS progress)
await window.api.updateCard(cardId, {
  front: newFront,
  back: newBack,
  cardType: newType,
});

// Reset progress
await window.api.updateCard(cardId, {
  stability: 0,
  difficulty: 0,
  dueDate: new Date().toISOString(),
  state: 0,  // New
  reps: 0,
  lapses: 0,
  elapsedDays: 0,
  scheduledDays: 0,
  lastReview: null,
});
```

---

# WORKFLOW 14: Suspend/Delete Card

## Flow

```
SUSPEND:
1. User clicks [Suspend] on card
2. Update card state to suspended (state = -1 or separate status field)
3. Card stops appearing in review
4. Can unsuspend later

DELETE:
1. User clicks [Delete] on card
2. Confirm: "Delete this card? This cannot be undone."
3. await window.api.deleteCard(cardId)
4. Decrement block.cardCount
```

---

# IMPLEMENTATION CHECKLIST

## Currently Working (MVP Core)
- [x] Workflow 1: Quick Capture
- [x] Workflow 2: Add to Notebook (basic - needs insight field emphasis)
- [x] Workflow 4: Browse Inbox
- [x] Workflow 5: Browse Notebook
- [x] Workflow 6: Block Detail (basic - no links sidebar)
- [x] Workflow 11: Generate Card
- [x] Workflow 12: Daily Review
- [x] Workflow 13: Edit Card
- [x] Workflow 14: Suspend/Delete Card

## MVP Required (Learning Core)
- [ ] Workflow 2 FIX: Prominent "What did you learn?" UI (this IS the learning)
- [ ] Workflow 7: Edit Block (refine insights over time)

## MVP Required (Cross-Topic Knowledge)
- [ ] Create notebook_links table (v16 migration)
- [ ] Workflow 8: Add Source to Another Topic (cross-specialty blocks)
- [ ] Workflow 9: Add Manual Link (explicit connections)
- [ ] Workflow 10: Remove Link
- [ ] Workflow 6 Enhancement: Links sidebar with hover-highlight

## MVP Polish
- [ ] Workflow 3: AI Backlink Detection (async, after block creation)

## Future Enhancements
- [ ] Content history tracking
- [ ] Card retirement criteria
- [ ] Anchor text re-detection after edits

---

# DONE

When you complete all workflows, you have a fully functional DougHub.

```
CORE LOOP:
Capture -> Notebook (write insight) -> (Backlinks) -> Cards -> Review

LAYER FLOW:
source_items -----> notebook_blocks (with user insight) -----> cards
     |                    |                                      |
     |                    +-- LINKS (cross-topic connections) ---+
     |                    |                                      |
     +-- One source can   +-- Same source, different topics,     |
         spawn multiple       different insights, linked         |
         blocks               together                           |

CROSS-TOPIC EXAMPLE:
"CKD causes CVD" (source)
    |
    +-> Block in Nephrology: "Manage CV risk in CKD patients"
    |         |
    |         +--[cross_specialty link]--+
    |                                    |
    +-> Block in Cardiology: "CKD is a coronary risk equivalent"
              |
              +-> Card: "CKD is a coronary risk equivalent because..."
```
